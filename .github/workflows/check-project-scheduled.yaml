name: Project Week Check (Scheduled) ðŸ””

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 10ì‹œ, ì˜¤í›„ 6ì‹œ (KST ê¸°ì¤€, UTCë¡œëŠ” 1ì‹œ, 9ì‹œ)
    - cron: "0 1,9 * * *"
  pull_request:
    types: [opened, reopened, synchronize, edited, labeled, unlabeled]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰

jobs:
  check-all-prs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # ëŒ“ê¸€ ìž‘ì„± ê¶Œí•œ

    steps:
      - name: Get all open PRs
        id: get-prs
        run: |
          echo "ðŸ“‹ Open PR ëª©ë¡ ì¡°íšŒ ì¤‘..."
          prs=$(gh pr list \
            --repo ${{ github.repository }} \
            --state open \
            --json number,labels \
            --limit 100)

          echo "prs=$prs" >> $GITHUB_OUTPUT
          echo "Open PR ìˆ˜: $(echo $prs | jq 'length')"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check Week settings for all PRs
        run: |
          prs='${{ steps.get-prs.outputs.prs }}'
          WORKER_URL="https://dalestudy.daleseo.workers.dev"
          repo_owner="${{ github.repository_owner }}"
          repo_name="${{ github.event.repository.name }}"

          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo $pr | jq -r '.number')
            labels=$(echo $pr | jq -r '.labels[].name' | tr '\n' ',')

            # maintenance ë¼ë²¨ì´ ìžˆìœ¼ë©´ ìŠ¤í‚µ
            if echo "$labels" | grep -q "maintenance"; then
              echo "â­ï¸  PR #$pr_number: maintenance ë¼ë²¨ - ìŠ¤í‚µ"
              continue
            fi

            echo ""
            echo "ðŸ” PR #$pr_number ê²€ì‚¬ ì¤‘..."

            # GitHub Appìœ¼ë¡œ Week ì„¤ì • í™•ì¸
            response=$(curl -s -X POST "$WORKER_URL" \
              -H "Content-Type: application/json" \
              -d "{\"pr_number\": $pr_number, \"repo_owner\": \"$repo_owner\", \"repo_name\": \"$repo_name\"}")

            week=$(echo $response | jq -r '.week')
            project_found=$(echo $response | jq -r '.project_found')

            echo "  Week: $week"
            echo "  Project found: $project_found"

            # Week ì„¤ì •ì´ ì—†ìœ¼ë©´ ëŒ“ê¸€ ìž‘ì„±
            if [ "$week" = "null" ] || [ -z "$week" ]; then
              echo "  âš ï¸  Week ì„¤ì • ëˆ„ë½ - ëŒ“ê¸€ ìž‘ì„±"

              # ì´ë¯¸ ë´‡ì´ ëŒ“ê¸€ì„ ë‹¬ì•˜ëŠ”ì§€ í™•ì¸
              existing_comment=$(gh pr view $pr_number \
                --repo ${{ github.repository }} \
                --json comments \
                --jq '.comments[] | select(.author.login == "github-actions[bot]") | select(.body | contains("Week ì„¤ì •ì´ ëˆ„ë½")) | .id' \
                | head -n 1)

              if [ -z "$existing_comment" ]; then
                # ìƒˆ ëŒ“ê¸€ ìž‘ì„±
                gh pr comment $pr_number \
                  --repo ${{ github.repository }} \
                  --body $'## âš ï¸ Week ì„¤ì •ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤\n\ní”„ë¡œì íŠ¸ì—ì„œ Weekë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!\n\n### ì„¤ì • ë°©ë²•\n1. PR ìš°ì¸¡ì˜ `Projects` ì„¹ì…˜ì—ì„œ `ë¦¬íŠ¸ì½”ë“œ ìŠ¤í„°ë””` ì˜† ë“œë¡­ë‹¤ìš´(â–¼) í´ë¦­\n2. í˜„ìž¬ ì£¼ì°¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” (ì˜ˆ: `Week 14(current)` ë˜ëŠ” `Week 14`)\n\nðŸ“š [ìžì„¸í•œ ê°€ì´ë“œ ë³´ê¸°](https://github.com/DaleStudy/leetcode-study/wiki/%EB%8B%B5%EC%95%88-%EC%A0%9C%EC%B6%9C-%EA%B0%80%EC%9D%B4%EB%93%9C#pr-%EC%9E%91%EC%84%B1%EB%B2%95)\n\n---\nðŸ¤– ì´ ëŒ“ê¸€ì€ GitHub Appì„ í†µí•´ ìžë™ìœ¼ë¡œ ìž‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'
                echo "  âœ… ëŒ“ê¸€ ìž‘ì„± ì™„ë£Œ"
              else
                echo "  â„¹ï¸  ì´ë¯¸ ì•Œë¦¼ ëŒ“ê¸€ì´ ìžˆìŒ - ìŠ¤í‚µ"
              fi
            else
              echo "  âœ… Week ì„¤ì • ì •ìƒ: $week"
            fi
          done
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Summary
        run: |
          echo "## ðŸŽ¯ Week ì„¤ì • ì²´í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ëª¨ë“  Open PRì˜ Week ì„¤ì •ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Week ì„¤ì •ì´ ì—†ëŠ” PRì— ìžë™ìœ¼ë¡œ ëŒ“ê¸€ì„ ìž‘ì„±í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "- ë‹¤ìŒ ì²´í¬: $(date -u -d '+1 hour' +'%Y-%m-%d %H:00 UTC')" >> $GITHUB_STEP_SUMMARY

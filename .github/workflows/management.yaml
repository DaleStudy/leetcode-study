name: Management ðŸ”§

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        default: "approve-prs"
        options:
          - approve-prs
          - merge-prs
      week:
        description: 'Week number to filter (optional, e.g., "1")'
        required: false
        type: string
        default: ""
      exclude_prs:
        description: 'PR numbers to exclude (comma-separated, e.g., "1972,1973")'
        required: false
        type: string
        default: ""

jobs:
  approve-prs:
    name: Approve Open PRs ðŸ‘
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'approve-prs' }}
    permissions:
      contents: read

    steps:
      - name: Approve PRs via GitHub App
        id: approve
        run: |
          echo "ðŸ‘ GitHub Appì„ í†µí•´ ëª¨ë“  Open PR ìŠ¹ì¸ ì¤‘..."

          # Parse exclude_prs input into JSON array
          exclude_input="${{ inputs.exclude_prs }}"
          if [ -z "$exclude_input" ]; then
            excludes="[]"
          else
            # Convert "1972,1973" to [1972,1973]
            excludes="[$(echo "$exclude_input" | sed 's/,/, /g')]"
          fi

          # Build request payload
          week_input="${{ inputs.week }}"
          if [ -z "$week_input" ]; then
            payload="{\"repo_name\": \"${{ github.event.repository.name }}\", \"excludes\": $excludes}"
          else
            payload="{\"repo_name\": \"${{ github.event.repository.name }}\", \"week\": \"Week $week_input\", \"excludes\": $excludes}"
          fi

          echo "ì£¼ì°¨ í•„í„°: ${week_input:-ì „ì²´}"
          echo "ì œì™¸í•  PR: $excludes"

          response=$(curl -s -X POST "https://github.dalestudy.com/approve-prs" \
            -H "Content-Type: application/json" \
            -d "$payload")

          echo "response=$response" >> $GITHUB_OUTPUT
          echo "$response" | jq '.'

      - name: Summary
        run: |
          response='${{ steps.approve.outputs.response }}'

          success=$(echo "$response" | jq -r '.success // false')
          total=$(echo "$response" | jq -r '.total_open_prs // 0')
          week_filter=$(echo "$response" | jq -r '.week_filter // null')
          week_matched=$(echo "$response" | jq -r '.week_matched // 0')
          week_mismatched=$(echo "$response" | jq -r '.week_mismatched // 0')
          solving_excluded=$(echo "$response" | jq -r '.solving_excluded // 0')
          processed=$(echo "$response" | jq -r '.processed // 0')
          approved=$(echo "$response" | jq -r '.approved // 0')
          skipped=$(echo "$response" | jq -r '.skipped // 0')

          echo "## ðŸ‘ PR ìŠ¹ì¸ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$success" = "true" ]; then
            echo "âœ… **ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$week_filter" != "null" ]; then
            echo "- ðŸ—“ï¸  ì£¼ì°¨ í•„í„°: **$week_filter**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ðŸ“‹ ì „ì²´ Open PR: **$total**ê°œ" >> $GITHUB_STEP_SUMMARY
          if [ "$week_filter" != "null" ]; then
            echo "- âœ… $week_filter ë§¤ì¹­: **$week_matched**ê°œ" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Week ë¶ˆì¼ì¹˜: **$week_mismatched**ê°œ" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”„ Solving ìƒíƒœ ì œì™¸: **$solving_excluded**ê°œ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ðŸ” ê²€ì‚¬í•œ PR: **$processed**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ìŠ¹ì¸í•œ PR: **$approved**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸  ê±´ë„ˆë›´ PR: **$skipped**ê°œ" >> $GITHUB_STEP_SUMMARY

          # Show detailed results if available
          result_count=$(echo "$response" | jq -r '.results | length')
          if [ "$result_count" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ ìƒì„¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "$response" | jq -c '.results[]' | while read -r item; do
              pr=$(echo "$item" | jq -r '.pr')
              title=$(echo "$item" | jq -r '.title')
              skipped=$(echo "$item" | jq -r '.skipped // false')
              approved=$(echo "$item" | jq -r '.approved // false')
              reason=$(echo "$item" | jq -r '.reason // ""')
              error=$(echo "$item" | jq -r '.error // ""')

              if [ "$skipped" = "true" ]; then
                echo "- PR #$pr [$title]: â­ï¸ skipped ($reason)" >> $GITHUB_STEP_SUMMARY
              elif [ "$approved" = "true" ]; then
                echo "- PR #$pr [$title]: âœ… approved" >> $GITHUB_STEP_SUMMARY
              else
                echo "- PR #$pr [$title]: âŒ failed (${error:-unknown})" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

  merge-prs:
    name: Merge Open PRs ðŸš€
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'merge-prs' }}
    permissions:
      contents: read

    steps:
      - name: Merge PRs via GitHub App
        id: merge
        run: |
          echo "ðŸš€ GitHub Appì„ í†µí•´ ëª¨ë“  ìŠ¹ì¸ëœ PR ë¨¸ì§€ ì¤‘..."

          # Parse exclude_prs input into JSON array
          exclude_input="${{ inputs.exclude_prs }}"
          if [ -z "$exclude_input" ]; then
            excludes="[]"
          else
            # Convert "1972,1973" to [1972,1973]
            excludes="[$(echo "$exclude_input" | sed 's/,/, /g')]"
          fi

          # Build request payload
          week_input="${{ inputs.week }}"
          merge_method="merge"

          if [ -z "$week_input" ]; then
            payload="{\"repo_name\": \"${{ github.event.repository.name }}\", \"merge_method\": \"$merge_method\", \"excludes\": $excludes}"
          else
            payload="{\"repo_name\": \"${{ github.event.repository.name }}\", \"merge_method\": \"$merge_method\", \"week\": \"Week $week_input\", \"excludes\": $excludes}"
          fi

          echo "ë¨¸ì§€ ë°©ì‹: $merge_method"
          echo "ì£¼ì°¨ í•„í„°: ${week_input:-ì „ì²´}"
          echo "ì œì™¸í•  PR: $excludes"

          response=$(curl -s -X POST "https://github.dalestudy.com/merge-prs" \
            -H "Content-Type: application/json" \
            -d "$payload")

          echo "response=$response" >> $GITHUB_OUTPUT
          echo "$response" | jq '.'

      - name: Summary
        run: |
          response='${{ steps.merge.outputs.response }}'

          success=$(echo "$response" | jq -r '.success // false')
          total=$(echo "$response" | jq -r '.total_open_prs // 0')
          week_filter=$(echo "$response" | jq -r '.week_filter // null')
          week_matched=$(echo "$response" | jq -r '.week_matched // 0')
          week_mismatched=$(echo "$response" | jq -r '.week_mismatched // 0')
          solving_excluded=$(echo "$response" | jq -r '.solving_excluded // 0')
          processed=$(echo "$response" | jq -r '.processed // 0')
          merged=$(echo "$response" | jq -r '.merged // 0')
          skipped=$(echo "$response" | jq -r '.skipped // 0')
          merge_method=$(echo "$response" | jq -r '.merge_method // "unknown"')

          echo "## ðŸš€ PR ë¨¸ì§€ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$success" = "true" ]; then
            echo "âœ… **ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ ë¨¸ì§€ ë°©ì‹: **$merge_method**" >> $GITHUB_STEP_SUMMARY
          if [ "$week_filter" != "null" ]; then
            echo "- ðŸ—“ï¸  ì£¼ì°¨ í•„í„°: **$week_filter**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ðŸ“‹ ì „ì²´ Open PR: **$total**ê°œ" >> $GITHUB_STEP_SUMMARY
          if [ "$week_filter" != "null" ]; then
            echo "- âœ… $week_filter ë§¤ì¹­: **$week_matched**ê°œ" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Week ë¶ˆì¼ì¹˜: **$week_mismatched**ê°œ" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”„ Solving ìƒíƒœ ì œì™¸: **$solving_excluded**ê°œ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ðŸ” ê²€ì‚¬í•œ PR: **$processed**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ë¨¸ì§€í•œ PR: **$merged**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸  ê±´ë„ˆë›´ PR: **$skipped**ê°œ" >> $GITHUB_STEP_SUMMARY

          # Show detailed results if available
          result_count=$(echo "$response" | jq -r '.results | length')
          if [ "$result_count" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ ìƒì„¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "$response" | jq -c '.results[]' | while read -r item; do
              pr=$(echo "$item" | jq -r '.pr')
              title=$(echo "$item" | jq -r '.title')
              skipped=$(echo "$item" | jq -r '.skipped // false')
              merged=$(echo "$item" | jq -r '.merged // false')
              reason=$(echo "$item" | jq -r '.reason // ""')
              error=$(echo "$item" | jq -r '.error // ""')

              if [ "$skipped" = "true" ]; then
                echo "- PR #$pr [$title]: â­ï¸ skipped ($reason)" >> $GITHUB_STEP_SUMMARY
              elif [ "$merged" = "true" ]; then
                echo "- PR #$pr [$title]: âœ… merged" >> $GITHUB_STEP_SUMMARY
              else
                echo "- PR #$pr [$title]: âŒ failed (${error:-unknown})" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

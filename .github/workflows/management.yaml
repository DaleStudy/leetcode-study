name: Management ðŸ”§

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        default: "approve-prs"
        options:
          - approve-prs
          - merge-prs
      exclude_prs:
        description: 'PR numbers to exclude (comma-separated, e.g., "1972,1973")'
        required: false
        type: string
        default: ""

jobs:
  approve-prs:
    name: Approve Open PRs ðŸ‘
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'approve-prs' }}
    permissions:
      contents: read

    steps:
      - name: Approve PRs via GitHub App
        id: approve
        run: |
          echo "ðŸ‘ GitHub Appì„ í†µí•´ ëª¨ë“  Open PR ìŠ¹ì¸ ì¤‘..."

          # Parse exclude_prs input into JSON array
          exclude_input="${{ inputs.exclude_prs }}"
          if [ -z "$exclude_input" ]; then
            excludes="[]"
          else
            # Convert "1972,1973" to [1972,1973]
            excludes="[$(echo "$exclude_input" | sed 's/,/, /g')]"
          fi

          echo "ì œì™¸í•  PR: $excludes"

          response=$(curl -s -X POST "https://github.dalestudy.com/approve-prs" \
            -H "Content-Type: application/json" \
            -d "{\"repo_name\": \"${{ github.event.repository.name }}\", \"excludes\": $excludes}")

          echo "response=$response" >> $GITHUB_OUTPUT
          echo "$response" | jq '.'

      - name: Summary
        run: |
          response='${{ steps.approve.outputs.response }}'

          success=$(echo "$response" | jq -r '.success // false')
          total=$(echo "$response" | jq -r '.total_open_prs // 0')
          processed=$(echo "$response" | jq -r '.processed // 0')
          approved=$(echo "$response" | jq -r '.approved // 0')
          skipped=$(echo "$response" | jq -r '.skipped // 0')

          echo "## ðŸ‘ PR ìŠ¹ì¸ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$success" = "true" ]; then
            echo "âœ… **ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ ì „ì²´ Open PR: **$total**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” ê²€ì‚¬í•œ PR: **$processed**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ìŠ¹ì¸í•œ PR: **$approved**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸  ê±´ë„ˆë›´ PR: **$skipped**ê°œ" >> $GITHUB_STEP_SUMMARY

          # Show detailed results if available
          results=$(echo "$response" | jq -r '.results // []')
          if [ "$results" != "[]" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ ìƒì„¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$response" | jq -r '.results[] | "- PR #\(.pr_number): \(.status) \(if .reason then "(\(.reason))" else "" end)"' >> $GITHUB_STEP_SUMMARY
          fi

  merge-prs:
    name: Merge Open PRs ðŸš€
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'merge-prs' }}
    permissions:
      contents: read

    steps:
      - name: Merge PRs via GitHub App
        id: merge
        run: |
          echo "ðŸš€ GitHub Appì„ í†µí•´ ëª¨ë“  ìŠ¹ì¸ëœ PR ë¨¸ì§€ ì¤‘..."

          # Parse exclude_prs input into JSON array
          exclude_input="${{ inputs.exclude_prs }}"
          if [ -z "$exclude_input" ]; then
            excludes="[]"
          else
            # Convert "1972,1973" to [1972,1973]
            excludes="[$(echo "$exclude_input" | sed 's/,/, /g')]"
          fi

          merge_method="merge"
          echo "ë¨¸ì§€ ë°©ì‹: $merge_method"
          echo "ì œì™¸í•  PR: $excludes"

          response=$(curl -s -X POST "https://github.dalestudy.com/merge-prs" \
            -H "Content-Type: application/json" \
            -d "{\"repo_name\": \"${{ github.event.repository.name }}\", \"merge_method\": \"$merge_method\", \"excludes\": $excludes}")

          echo "response=$response" >> $GITHUB_OUTPUT
          echo "$response" | jq '.'

      - name: Summary
        run: |
          response='${{ steps.merge.outputs.response }}'

          success=$(echo "$response" | jq -r '.success // false')
          total=$(echo "$response" | jq -r '.total_open_prs // 0')
          processed=$(echo "$response" | jq -r '.processed // 0')
          merged=$(echo "$response" | jq -r '.merged // 0')
          skipped=$(echo "$response" | jq -r '.skipped // 0')
          merge_method=$(echo "$response" | jq -r '.merge_method // "unknown"')

          echo "## ðŸš€ PR ë¨¸ì§€ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$success" = "true" ]; then
            echo "âœ… **ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ ë¨¸ì§€ ë°©ì‹: **$merge_method**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ ì „ì²´ Open PR: **$total**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” ê²€ì‚¬í•œ PR: **$processed**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ë¨¸ì§€í•œ PR: **$merged**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸  ê±´ë„ˆë›´ PR: **$skipped**ê°œ" >> $GITHUB_STEP_SUMMARY

          # Show detailed results if available
          results=$(echo "$response" | jq -r '.results // []')
          if [ "$results" != "[]" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ ìƒì„¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$response" | jq -r '.results[] | "- PR #\(.pr_number): \(.status) \(if .reason then "(\(.reason))" else "" end)"' >> $GITHUB_STEP_SUMMARY
          fi

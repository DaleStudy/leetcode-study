name: Week Check ðŸ—“ï¸

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 10ì‹œ, ì˜¤í›„ 6ì‹œ (KST ê¸°ì¤€, UTCë¡œëŠ” 1ì‹œ, 9ì‹œ)
    - cron: "0 1,9 * * *"
  workflow_dispatch:
  pull_request:

jobs:
  check-all-prs:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Check all PRs via GitHub App
        id: check
        run: |
          echo "ðŸ” GitHub Appì„ í†µí•´ ëª¨ë“  Open PR ê²€ì‚¬ ì¤‘..."

          response=$(curl -s -X POST "https://github.dalestudy.com/check-weeks" \
            -H "Content-Type: application/json" \
            -d "{\"repo_owner\": \"${{ github.repository_owner }}\", \"repo_name\": \"${{ github.event.repository.name }}\"}")

          echo "response=$response" >> $GITHUB_OUTPUT
          echo "$response" | jq '.'

      - name: Summary
        run: |
          response='${{ steps.check.outputs.response }}'

          total=$(echo "$response" | jq -r '.total_prs // 0')
          checked=$(echo "$response" | jq -r '.checked // 0')
          commented=$(echo "$response" | jq -r '.commented // 0')
          deleted=$(echo "$response" | jq -r '.deleted // 0')

          echo "## ðŸŽ¯ Week ì„¤ì • ì²´í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ ì „ì²´ Open PR: **$total**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ê²€ì‚¬í•œ PR: **$checked**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¬ ëŒ“ê¸€ ìž‘ì„±í•œ PR: **$commented**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸  ëŒ“ê¸€ ì‚­ì œí•œ PR: **$deleted**ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë‹¤ìŒ ì²´í¬: $(date -u -d '+1 hour' +'%Y-%m-%d %H:00 UTC')" >> $GITHUB_STEP_SUMMARY
